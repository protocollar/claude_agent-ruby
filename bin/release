#!/usr/bin/env bash
set -euo pipefail

# Release script for claude_agent gem
# Usage: bin/release 1.2.3
#
# This script:
# 1. Updates lib/claude_agent/version.rb
# 2. Updates Gemfile.lock
# 3. Commits, tags, and pushes to main
# 4. Creates a GitHub release
# 5. Builds and publishes the gem to RubyGems

VERSION=${1:-}

if [[ -z "$VERSION" ]]; then
  echo "Usage: bin/release VERSION (e.g., bin/release 1.2.3)"
  exit 1
fi

if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
  echo "Invalid version format. Use semantic versioning (e.g., 1.2.3)"
  exit 1
fi

if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
  echo "CHANGELOG.md does not have an entry for version $VERSION"
  echo "Please add a changelog entry before releasing"
  exit 1
fi

if git tag -l "v$VERSION" | grep -q "v$VERSION"; then
  echo "Tag v$VERSION already exists"
  exit 1
fi

# Prompt for OTP upfront
read -p "Enter RubyGems OTP code: " OTP

if [[ -z "$OTP" ]]; then
  echo "OTP is required"
  exit 1
fi

echo "Releasing $VERSION..."

printf "# frozen_string_literal: true\n\nmodule ClaudeAgent\n  VERSION = \"$VERSION\"\nend\n" > lib/claude_agent/version.rb
bundle install
git add Gemfile.lock lib/claude_agent/version.rb
git commit -m "Bump version for $VERSION"
git push
git tag v$VERSION
git push --tags
gh release create "v$VERSION" --title "v$VERSION" --notes-from-tag
gem build claude_agent.gemspec
gem push "claude_agent-$VERSION.gem" --host https://rubygems.org --otp "$OTP"
rm "claude_agent-$VERSION.gem"

echo "Released claude_agent $VERSION"
