#!/usr/bin/env bash
set -euo pipefail

# Release preparation script for claude_agent gem
# Usage: bin/release 1.2.3
#
# This script prepares a release PR:
# 1. Creates a release branch
# 2. Updates lib/claude_agent/version.rb
# 3. Updates Gemfile.lock
# 4. Moves [Unreleased] changelog entries to new version
# 5. Commits and pushes the branch
# 6. Opens a PR
#
# After the PR is merged, run: bin/publish 1.2.3

VERSION=${1:-}

if [[ -z "$VERSION" ]]; then
  echo "Usage: bin/release VERSION (e.g., bin/release 1.2.3)"
  exit 1
fi

if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
  echo "Invalid version format. Use semantic versioning (e.g., 1.2.3)"
  exit 1
fi

if git tag -l "v$VERSION" | grep -q "v$VERSION"; then
  echo "Tag v$VERSION already exists"
  exit 1
fi

BRANCH="release-$VERSION"

if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
  echo "Branch $BRANCH already exists"
  exit 1
fi

echo "Preparing release $VERSION..."

# Create release branch
git checkout -b "$BRANCH"

# Update version.rb
printf "# frozen_string_literal: true\n\nmodule ClaudeAgent\n  VERSION = \"$VERSION\"\nend\n" > lib/claude_agent/version.rb

# Update Gemfile.lock
bundle install

# Update changelog - insert version header after [Unreleased]
DATE=$(date +%Y-%m-%d)
sed -i '' "s/## \[Unreleased\]/## [Unreleased]\\
\\
## [$VERSION] - $DATE/" CHANGELOG.md

# Commit
git add lib/claude_agent/version.rb Gemfile.lock CHANGELOG.md
git commit -m "Release $VERSION"

# Push branch
git push -u origin "$BRANCH"

# Create PR
gh pr create --title "Release $VERSION" --body "## Release $VERSION

This PR prepares the release of version $VERSION.

### After merging

Run the following to publish:

\`\`\`bash
git checkout main && git pull
bin/publish $VERSION
\`\`\`
"

echo ""
echo "Release PR created. After it's merged, run:"
echo ""
echo "  git checkout main && git pull"
echo "  bin/publish $VERSION"
